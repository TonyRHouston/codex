name: Close stale contributor PRs
on:
  workflow_dispatch: {}
permissions:
  contents: read
  issues: write
  pull-requests: write
jobs:
  close-stale-contributor-prs:
    if: github.repository == 'openai/codex'
    runs-on: ubuntu-latest
    steps:
    - name: Close inactive PRs from contributors
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: "const DAYS_INACTIVE = 14;\nconst cutoff = new Date(Date.now() - DAYS_INACTIVE * 24 * 60 * 60 * 1000);\nconst { owner, repo } = context.repo;\nconst dryRun = false;\nconst stalePrs = [];\n\ncore.info(`Dry run mode: ${dryRun}`);\n\nconst prs = await github.paginate(github.rest.pulls.list, {\n  owner,\n  repo,\n  state: \"open\",\n  per_page: 100,\n  sort: \"updated\",\n  direction: \"asc\",\n});\n\nfor (const pr of prs) {\n  const lastUpdated = new Date(pr.updated_at);\n  if (lastUpdated > cutoff) {\n    core.info(`PR ${pr.number} is fresh`);\n    continue;\n  }\n\n  if (!pr.user || pr.user.type !== \"User\") {\n    core.info(`PR ${pr.number} wasn't created by a user`);\n    continue;\n  }\n\n  let permission;\n  try {\n    const permissionResponse = await github.rest.repos.getCollaboratorPermissionLevel({\n      owner,\n      repo,\n      username: pr.user.login,\n    });\n    permission = permissionResponse.data.permission;\n  } catch (error) {\n    if (error.status ===\
          \ 404) {\n      core.info(`Author ${pr.user.login} is not a collaborator; skipping #${pr.number}`);\n      continue;\n    }\n    throw error;\n  }\n\n  const hasContributorAccess = [\"admin\", \"maintain\", \"write\"].includes(permission);\n  if (!hasContributorAccess) {\n    core.info(`Author ${pr.user.login} has ${permission} access; skipping #${pr.number}`);\n    continue;\n  }\n\n  stalePrs.push(pr);\n}\n\nif (!stalePrs.length) {\n  core.info(\"No stale contributor pull requests found.\");\n  return;\n}\n\nfor (const pr of stalePrs) {\n  const issue_number = pr.number;\n  const closeComment = `Closing this pull request because it has had no updates for more than ${DAYS_INACTIVE} days. If you plan to continue working on it, feel free to reopen or open a new PR.`;\n\n  if (dryRun) {\n    core.info(`[dry-run] Would close contributor PR #${issue_number} from ${pr.user.login}`);\n    continue;\n  }\n\n  await github.rest.issues.createComment({\n    owner,\n    repo,\n    issue_number,\n\
          \    body: closeComment,\n  });\n\n  await github.rest.pulls.update({\n    owner,\n    repo,\n    pull_number: issue_number,\n    state: \"closed\",\n  });\n\n  core.info(`Closed contributor PR #${issue_number} from ${pr.user.login}`);\n}\n"
