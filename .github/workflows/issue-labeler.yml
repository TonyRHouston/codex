name: Issue Labeler
on:
  workflow_dispatch: {}
jobs:
  gather-labels:
    name: Generate label suggestions
    if: github.repository == 'openai/codex' && (github.event.action == 'opened' || (github.event.action == 'labeled' && github.event.label.name == 'codex-label'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      codex_output: ${{ steps.codex.outputs.final-message }}
    steps:
    - uses: actions/checkout@v6
    - id: codex
      uses: openai/codex-action@main
      with:
        openai-api-key: ${{ secrets.CODEX_OPENAI_API_KEY }}
        allow-users: '*'
        prompt: "You are an assistant that reviews GitHub issues for the repository.\n\nYour job is to choose the most appropriate labels for the issue described later in this prompt.\nFollow these rules:\n\n- Add one (and only one) of the following three labels to distinguish the type of issue. Default to \"bug\" if unsure.\n1. bug \u2014 Reproducible defects in Codex products (CLI, VS Code extension, web, auth).\n2. enhancement \u2014 Feature requests or usability improvements that ask for new capabilities, better ergonomics, or quality-of-life tweaks.\n3. documentation \u2014 Updates or corrections needed in docs/README/config references (broken links, missing examples, outdated keys, clarification requests).\n\n- If applicable, add one of the following labels to specify which sub-product or product surface the issue relates to.\n1. CLI \u2014 the Codex command line interface.\n2. extension \u2014 VS Code (or other IDE) extension-specific issues.\n3. app - Issues related to the Codex\
          \ desktop application.\n4. codex-web \u2014 Issues targeting the Codex web UI/Cloud experience.\n5. github-action \u2014 Issues with the Codex GitHub action.\n6. iOS \u2014 Issues with the Codex iOS app.\n\n- Additionally add zero or more of the following labels that are relevant to the issue content. Prefer a small set of precise labels over many broad ones.\n1. windows-os \u2014 Bugs or friction specific to Windows environments (always when PowerShell is mentioned, path handling, copy/paste, OS-specific auth or tooling failures).\n2. mcp \u2014 Topics involving Model Context Protocol servers/clients.\n3. mcp-server \u2014 Problems related to the codex mcp-server command, where codex runs as an MCP server.\n4. azure \u2014 Problems or requests tied to Azure OpenAI deployments.\n5. model-behavior \u2014 Undesirable LLM behavior: forgetting goals, refusing work, hallucinating environment details, quota misreports, or other reasoning/performance anomalies.\n6. code-review \u2014\
          \ Issues related to the code review feature or functionality.\n7. auth - Problems related to authentication, login, or access tokens.\n8. codex-exec - Problems related to the \"codex exec\" command or functionality.\n9. context-management - Problems related to compaction, context windows, or available context reporting.\n10. custom-model - Problems that involve using custom model providers, local models, or OSS models.\n11. rate-limits - Problems related to token limits, rate limits, or token usage reporting.\n12. sandbox - Issues related to local sandbox environments or tool call approvals to override sandbox restrictions.\n13. tool-calls - Problems related to specific tool call invocations including unexpected errors, failures, or hangs.\n14. TUI - Problems with the terminal user interface (TUI) including keyboard shortcuts, copy & pasting, menus, or screen update issues.\n\nIssue number: ${{ github.event.issue.number }}\n\nIssue title:\n${{ github.event.issue.title }}\n\nIssue\
          \ body:\n${{ github.event.issue.body }}\n\nRepository full name:\n${{ github.repository }}\n"
        output-schema: "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"labels\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"labels\"],\n  \"additionalProperties\": false\n}\n"
  apply-labels:
    name: Apply labels from Codex output
    needs: gather-labels
    if: ${{ needs.gather-labels.result != 'skipped' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      CODEX_OUTPUT: ${{ needs.gather-labels.outputs.codex_output }}
    steps:
    - name: Apply labels
      run: "json=${CODEX_OUTPUT//$'\\r'/}\nif [ -z \"$json\" ]; then\n  echo \"Codex produced no output. Skipping label application.\"\n  exit 0\nfi\n\nif ! printf '%s' \"$json\" | jq -e 'type == \"object\" and (.labels | type == \"array\")' >/dev/null 2>&1; then\n  echo \"Codex output did not include a labels array. Raw output: $json\"\n  exit 0\nfi\n\nlabels=$(printf '%s' \"$json\" | jq -r '.labels[] | tostring')\nif [ -z \"$labels\" ]; then\n  echo \"Codex returned an empty array. Nothing to do.\"\n  exit 0\nfi\n\ncmd=(gh issue edit \"$ISSUE_NUMBER\")\nwhile IFS= read -r label; do\n  cmd+=(--add-label \"$label\")\ndone <<< \"$labels\"\n\n\"${cmd[@]}\" || true\n"
    - name: Remove codex-label trigger
      if: ${{ always() && github.event.action == 'labeled' && github.event.label.name == 'codex-label' }}
      run: 'gh issue edit "$ISSUE_NUMBER" --remove-label codex-label || true

        echo "Attempted to remove label: codex-label"

        '
