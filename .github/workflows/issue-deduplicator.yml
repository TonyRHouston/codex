name: Issue Deduplicator
on:
  issues:
    types:
    - opened
    - labeled
  workflow_dispatch: {}
jobs:
  gather-duplicates:
    name: Identify potential duplicates
    if: github.repository == 'openai/codex' && (github.event.action == 'opened' || (github.event.action == 'labeled' && github.event.label.name == 'codex-deduplicate'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      codex_output: ${{ steps.codex.outputs.final-message }}
    steps:
    - uses: actions/checkout@v6
    - name: Prepare Codex inputs
      env:
        GH_TOKEN: ${{ github.token }}
      run: "set -eo pipefail\n\nCURRENT_ISSUE_FILE=codex-current-issue.json\nEXISTING_ISSUES_FILE=codex-existing-issues.json\n\ngh issue list --repo \"${{ github.repository }}\" \\\n  --json number,title,body,createdAt \\\n  --limit 1000 \\\n  --state all \\\n  --search \"sort:created-desc\" \\\n  | jq '.' \\\n  > \"$EXISTING_ISSUES_FILE\"\n\ngh issue view \"${{ github.event.issue.number }}\" \\\n  --repo \"${{ github.repository }}\" \\\n  --json number,title,body \\\n  | jq '.' \\\n  > \"$CURRENT_ISSUE_FILE\"\n"
    - id: codex
      uses: openai/codex-action@main
      with:
        openai-api-key: ${{ secrets.CODEX_OPENAI_API_KEY }}
        allow-users: '*'
        prompt: "You are an assistant that triages new GitHub issues by identifying potential duplicates.\n\nYou will receive the following JSON files located in the current working directory:\n- `codex-current-issue.json`: JSON object describing the newly created issue (fields: number, title, body).\n- `codex-existing-issues.json`: JSON array of recent issues (each element includes number, title, body, createdAt).\n\nInstructions:\n- Compare the current issue against the existing issues to find up to five that appear to describe the same underlying problem or request.\n- Focus on the underlying intent and context of each issue\u2014such as reported symptoms, feature requests, reproduction steps, or error messages\u2014rather than relying solely on string similarity or synthetic metrics.\n- After your analysis, validate your results in 1-2 lines explaining your decision to return the selected matches.\n- When unsure, prefer returning fewer matches.\n- Include at most five numbers.\n"
        output-schema: "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"issues\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    },\n    \"reason\": { \"type\": \"string\" }\n  },\n  \"required\": [\"issues\", \"reason\"],\n  \"additionalProperties\": false\n}\n"
  comment-on-issue:
    name: Comment with potential duplicates
    needs: gather-duplicates
    if: ${{ needs.gather-duplicates.result != 'skipped' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
    - name: Comment on issue
      uses: actions/github-script@v8
      env:
        CODEX_OUTPUT: ${{ needs.gather-duplicates.outputs.codex_output }}
      with:
        github-token: ${{ github.token }}
        script: "const raw = process.env.CODEX_OUTPUT ?? '';\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (error) {\n  core.info(`Codex output was not valid JSON. Raw output: ${raw}`);\n  core.info(`Parse error: ${error.message}`);\n  return;\n}\n\nconst issues = Array.isArray(parsed?.issues) ? parsed.issues : [];\nconst currentIssueNumber = String(context.payload.issue.number);\n\nconsole.log(`Current issue number: ${currentIssueNumber}`);\nconsole.log(issues);\n\nconst filteredIssues = issues.filter((value) => String(value) !== currentIssueNumber);\n\nif (filteredIssues.length === 0) {\n  core.info('Codex reported no potential duplicates.');\n  return;\n}\n\nconst lines = [\n  'Potential duplicates detected. Please review them and close your issue if it is a duplicate.',\n  '',\n  ...filteredIssues.map((value) => `- #${String(value)}`),\n  '',\n  '*Powered by [Codex Action](https://github.com/openai/codex-action)*'];\n\nawait github.rest.issues.createComment({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  issue_number: context.payload.issue.number,\n  body: lines.join(\"\\n\"),\n});\n"
    - name: Remove codex-deduplicate label
      if: ${{ always() && github.event.action == 'labeled' && github.event.label.name == 'codex-deduplicate' }}
      env:
        GH_TOKEN: ${{ github.token }}
        GH_REPO: ${{ github.repository }}
      run: 'gh issue edit "${{ github.event.issue.number }}" --remove-label codex-deduplicate || true

        echo "Attempted to remove label: codex-deduplicate"

        '
